<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FarmRPG Crafting</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }
    label { font-weight: bold; margin-right: 6px; }
    input, select, button { margin-right: 12px; padding: 4px; }
    #totalsTable { margin-top: 24px; border-collapse: collapse; display: none; }
    #totalsTable th, #totalsTable td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    #totalsTable th { background: #f6f6f6 }
  </style>
</head>
<body>
  <h2>FarmRPG Crafting</h2>

  <label for="searchBox">Item:</label>
  <input id="searchBox" list="recipeList" placeholder="Start typing…" />
  <datalist id="recipeList"></datalist>

  <label for="qtyInput">Quantity:</label>
  <input type="number" id="qtyInput" min="1" value="1" style="width:70px;" />
  <button onclick="updateChart()">Update</button>

  <div id="sankey" style="width: 100%; height: 500px; margin-top: 20px;"></div>

  <table id="totalsTable">
    <thead><tr><th>Raw Material</th><th>Total Needed</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    let recipes = {};

    google.charts.load('current', { packages: ['sankey'] });

    fetch('crafting_recipes.json')
      .then(res => res.json())
      .then(data => {
        recipes = data;
        buildSearchOptions(Object.keys(recipes));
        google.charts.setOnLoadCallback(() => drawSankey("Wooden Plank", 1));
      });

    function buildSearchOptions(items) {
      const list = document.getElementById('recipeList');
      items.sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        list.appendChild(opt);
      });
    }

    function updateChart() {
      const item = document.getElementById('searchBox').value.trim();
      const qty = parseInt(document.getElementById('qtyInput').value, 10);
      if (!recipes[item]) return alert("Unknown craftable item.");
      if (isNaN(qty) || qty <= 0) return alert("Quantity must be positive.");
      drawSankey(item, qty);
    }

    function drawSankey(targetItem, qty) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'From');
      data.addColumn('string', 'To');
      data.addColumn('number', 'Quantity');

      const links = [], rawTotals = {};

      function resolve(item, amount) {
        const recipe = recipes[item];
        if (recipe && recipe.inputs) {
          recipe.inputs.forEach(inp => {
            const need = inp.quantity * amount;
            links.push([`${need}× ${inp.item}`, `${amount}× ${item}`, need]);
            resolve(inp.item, need);
          });
        } else {
          rawTotals[item] = (rawTotals[item] || 0) + amount;
        }
      }

      resolve(targetItem, qty);
      data.addRows(links);

      const chart = new google.visualization.Sankey(document.getElementById('sankey'));
      chart.draw(data, {
        sankey: {
          node: {
            label: { fontSize: 14 },
            nodePadding: 32
          }
        }
      });

      const tbody = document.querySelector('#totalsTable tbody');
      tbody.innerHTML = '';
      Object.entries(rawTotals)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([mat, total]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${mat}</td><td>${total}</td>`;
          tbody.appendChild(tr);
        });
      document.getElementById('totalsTable').style.display = 'table';
    }
  </script>
</body>
</html>
