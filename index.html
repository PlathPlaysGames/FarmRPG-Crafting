<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FarmRPG Crafting</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      transition: background 0.3s, color 0.3s;
    }

    body.light-mode {
      background-color: #ffffff;
      color: #000000;
    }

    body.dark-mode {
      background-color: #121212;
      color: #eeeeee;
    }

    label {
      font-weight: bold;
      margin-right: 6px;
    }

    input, select, button {
      margin-right: 12px;
      padding: 4px;
      background-color: inherit;
      color: inherit;
      border: 1px solid #888;
    }

    button:hover {
      cursor: pointer;
      opacity: 0.85;
    }

    #totalsTable {
      margin-top: 24px;
      border-collapse: collapse;
      display: none;
    }

    #totalsTable th, #totalsTable td {
      border: 1px solid #888;
      padding: 6px 10px;
      text-align: left;
    }

    #totalsTable th {
      background: #222;
      color: #fff;
    }

    body.light-mode #totalsTable th {
      background: #f6f6f6;
      color: #000;
    }

    #themeToggle {
      margin-bottom: 16px;
    }

    h3 {
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <h2>FarmRPG Crafting</h2>

  <button id="themeToggle" onclick="toggleTheme()">Toggle Light/Dark Mode</button><br><br>

  <label for="itemSelect">Item:</label>
  <select id="itemSelect"></select>

  <label for="qtyInput">Quantity:</label>
  <input type="number" id="qtyInput" min="1" value="1" style="width:70px;" />
  <button onclick="updateChart()">Update</button>

  <div id="sankey" style="width: 100%; height: 500px; margin-top: 20px;"></div>

  <h3>Raw Materials Summary</h3>
  <table id="totalsTable">
    <thead><tr><th>Raw Material</th><th>Total Needed</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>All Ingredients Summary</h3>
  <table id="fullTable">
    <thead><tr><th>Ingredient</th><th>Total Needed</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    let recipes = {};
    google.charts.load('current', { packages: ['sankey'] });

    fetch('crafting-recipes.json')
      .then(res => res.json())
      .then(data => {
        recipes = data;
        buildSearchOptions(Object.keys(recipes));
        const savedTheme = localStorage.getItem('theme') || 'light-mode';
        document.body.classList.add(savedTheme);
        google.charts.setOnLoadCallback(() => drawSankey("Grand Piano", 1));
      });

    function buildSearchOptions(items) {
      const select = document.getElementById('itemSelect');
      select.innerHTML = '';
      items.sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      document.getElementById('itemSelect').value = "Grand Piano";
    }

    function updateChart() {
      const item = document.getElementById('itemSelect').value;
      const qty = parseInt(document.getElementById('qtyInput').value, 10);
      if (!recipes[item]) return alert("Unknown craftable item.");
      if (isNaN(qty) || qty <= 0) return alert("Quantity must be positive.");
      drawSankey(item, qty);
    }

    function drawSankey(targetItem, qty) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'From');
      data.addColumn('string', 'To');
      data.addColumn('number', 'Quantity');

      const links = [], rawTotals = {}, allTotals = {};

      function resolve(item, amount) {
        allTotals[item] = (allTotals[item] || 0) + amount;
        const recipe = recipes[item];
        if (recipe && recipe.inputs) {
          recipe.inputs.forEach(inp => {
            const need = inp.quantity * amount;
            links.push([`${need}× ${inp.item}`, `${amount}× ${item}`, need]);
            resolve(inp.item, need);
          });
        } else {
          rawTotals[item] = (rawTotals[item] || 0) + amount;
        }
      }

      resolve(targetItem, qty);
      data.addRows(links);

      const isDark = document.body.classList.contains('dark-mode');

      const chart = new google.visualization.Sankey(document.getElementById('sankey'));
      chart.draw(data, {
        sankey: {
          node: {
            label: { fontSize: 14, color: isDark ? '#eee' : '#000' },
            nodePadding: 32,
            colorMode: 'gradient',
            colors: isDark ? ['#bb86fc', '#03dac6'] : ['#6200ee', '#018786']
          },
          link: {
            colorMode: 'gradient',
            colors: isDark ? ['#666'] : ['#bbb']
          }
        }
      });

      renderTable('totalsTable', rawTotals);
      renderTable('fullTable', allTotals);
    }

    function renderTable(tableId, totals) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      Object.entries(totals)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([mat, total]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${mat}</td><td>${total}</td>`;
          tbody.appendChild(tr);
        });
      document.getElementById(tableId).style.display = 'table';
    }

    function toggleTheme() {
      const body = document.body;
      const current = body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
      const next = current === 'dark-mode' ? 'light-mode' : 'dark-mode';
      body.classList.replace(current, next);
      localStorage.setItem('theme', next);
      updateChart(); // redraw chart with new theme
    }
  </script>
</body>
</html>
