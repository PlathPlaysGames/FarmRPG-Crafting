<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DAG Item Tree Viewer</title>
<meta name="description" content="Interactive item tree (DAG) with search, sort, filter, collapse, hide, and details panel." />
<style>
  :root { --bg:#ffffff; --fg:#111827; --accent:#2563eb; --muted:#6b7280; --panel:#f3f4f6; --card:#ffffff; --border:#e5e7eb; }
  body.dark { --bg:#0b0f16; --fg:#e5e7eb; --accent:#60a5fa; --muted:#9ca3af; --panel:#111827; --card:#0e1420; --border:#1f2937; }
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg); display:flex; flex-direction:column; }
  header { position:sticky; top:0; z-index:10; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--bg), transparent 10%); border-bottom:1px solid var(--border); }
  .bar { display:flex; flex-wrap:wrap; gap:.5rem; padding:.6rem; align-items:center; }
  .bar input[type="text"], .bar select { padding:.5rem .6rem; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); }
  .bar button { padding:.5rem .7rem; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); cursor:pointer; }
  .bar button:hover { border-color:var(--accent); }
  main { display:flex; flex:1; min-height:0; }
  #tree { flex:1; padding: .75rem; overflow:auto; }
  ul { list-style:none; margin:0; padding-left:1rem; }
  li { margin:.15rem 0; }
  li.collapsed > ul { display:none; }
  .node { display:flex; gap:.5rem; align-items:center; padding:.25rem .4rem; border-radius:8px; }
  .node:hover { background: color-mix(in oklab, var(--accent), transparent 90%); }
  .node .label { cursor:pointer; display:flex; align-items:center; gap:.4rem; flex:1; min-width:0; }
  .swatch { width:.75rem; height:.75rem; border-radius:2px; }
  .id { color:var(--muted); font-size:.82em; white-space:nowrap; }
  .actions { display:flex; gap:.35rem; }
  .actions button { font-size:.8em; padding:.25rem .45rem; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--fg); }
  .actions button:hover { border-color:var(--accent); }
  .muted { color:var(--muted); }
  /* Details */
  aside#details { width:min(440px, 95vw); background:var(--panel); border-left:1px solid var(--border); padding:1rem; overflow:auto;
    transform:translateX(100%); transition:transform .25s ease; }
  body.show-details aside#details { transform:translateX(0); }
  .details-header { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
  .details-title { font-weight:700; font-size:1.05rem; }
  .chip { display:inline-block; padding:.15rem .45rem; border-radius:999px; background: color-mix(in oklab, var(--fg), transparent 88%);
    color: var(--fg); margin:.1rem .25rem 0 0; font-size:.75rem; }
  .section { margin:.8rem 0; }
  .section h3 { margin:.1rem 0 .4rem; font-size:.95rem; }
  .list-compact { margin:0; padding-left:1.1rem; }
  .empty { color:var(--muted); font-style:italic; }
  @media (max-width: 720px) {
    aside#details { width:100vw; }
    .bar input[type="text"] { flex:1; }
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <input id="search" type="text" placeholder="Search labels, IDs, or tags…" />
    <select id="tagFilter"><option value="">All Tags</option></select>
    <select id="sortMode">
      <option value="labelAsc">Label (A→Z)</option>
      <option value="labelDesc">Label (Z→A)</option>
      <option value="idAsc">ID (A→Z)</option>
      <option value="idDesc">ID (Z→A)</option>
      <option value="none">No Sorting (JSON order)</option>
    </select>
    <button id="expandAll" title="Expand all nodes">Expand All</button>
    <button id="collapseAll" title="Collapse all nodes">Collapse All</button>
    <button id="toggleTheme" title="Toggle light/dark">Theme</button>
    <button id="resetState" title="Clear hidden/collapsed state">Reset</button>
  </div>
</header>

<main>
  <div id="tree" role="tree" aria-label="Item tree"></div>
  <aside id="details" aria-labelledby="details-title">
    <div class="details-header">
      <div class="details-title" id="details-title">Details</div>
      <button id="closeDetails" aria-label="Close details">✕</button>
    </div>
    <div id="detailsBody"></div>
  </aside>
</main>

<script>
const STORAGE_KEY = 'dag-tree-state-v11';
let state = { collapsed:{}, hidden:{}, theme:'light', sortMode:'labelAsc', tagFilter:'' };
try { state = {...state, ...JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}; } catch {}
if (state.theme==='dark') document.body.classList.add('dark');
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

const app = {
  map: new Map(),          // id -> node
  children: new Map(),     // id -> [childIds]
  roots: [],               // [root id]
  edgesByChild: new Map(), // childId -> [{from, quantity}]
  edgesByParent: new Map() // parentId -> [{to, quantity}]
};

function el(id){ return document.getElementById(id); }

async function loadJSON(path){
  const res = await fetch(path, {cache:'no-store'});
  if (!res.ok) throw new Error(path+' not found');
  return res.json();
}

function uniqueSorted(arr){ return Array.from(new Set(arr)).sort(); }

async function init(){
  let data = [];
  try { data = await loadJSON('data.json'); }
  catch(e){ el('tree').innerHTML = '<p style="color:red">data.json not found</p>'; console.error(e); return; }

  // Build structures
  app.map = new Map(data.map(n => [n.id, n]));
  app.children = new Map();
  app.roots = [];
  const appearsAsChild = new Set();

  data.forEach(n => {
    (n.parents||[]).forEach(p => {
      if (!app.children.has(p)) app.children.set(p, []);
      app.children.get(p).push(n.id);
      appearsAsChild.add(n.id);
    });
  });

  data.forEach(n => { if (!appearsAsChild.has(n.id)) app.roots.push(n.id); });

  // Load edges.json if available
  try {
    const edges = await loadJSON('edges.json');
    const byChild = new Map(), byParent = new Map();
    for (const e of edges){
      const {from, to, quantity} = e;
      if (!byChild.has(to)) byChild.set(to, []);
      byChild.get(to).push({from, quantity});
      if (!byParent.has(from)) byParent.set(from, []);
      byParent.get(from).push({to, quantity});
    }
    // Sort for readability
    for (const arr of byChild.values()) arr.sort((a,b)=>a.from.localeCompare(b.from));
    for (const arr of byParent.values()) arr.sort((a,b)=>a.to.localeCompare(b.to));
    app.edgesByChild = byChild; app.edgesByParent = byParent;
  } catch(_) { /* optional */ }

  // Tag dropdown
  const allTags = new Set();
  data.forEach(n => (n.tags||[]).forEach(t=>allTags.add(t)));
  const tagSelect = el('tagFilter');
  uniqueSorted([...allTags]).forEach(t => {
    const opt = document.createElement('option'); opt.value = t; opt.textContent = t;
    tagSelect.appendChild(opt);
  });
  tagSelect.value = state.tagFilter;

  // Wire controls
  el('search').oninput = () => renderTree();
  el('tagFilter').onchange = (e)=>{ state.tagFilter = e.target.value; saveState(); renderTree(); };
  el('sortMode').onchange = (e)=>{ state.sortMode = e.target.value; saveState(); renderTree(); };
  el('expandAll').onclick = ()=>{ state.collapsed = {}; saveState(); renderTree(); };
  el('collapseAll').onclick = ()=>{ app.map.forEach((_,id)=>state.collapsed[id]=true); saveState(); renderTree(); };
  el('toggleTheme').onclick = ()=>{ document.body.classList.toggle('dark'); state.theme = document.body.classList.contains('dark') ? 'dark':'light'; saveState(); };
  el('resetState').onclick = ()=>{ if (confirm('Clear collapsed/hidden state?')) { state.collapsed = {}; state.hidden = {}; saveState(); renderTree(); } };
  el('closeDetails').onclick = ()=>{ document.body.classList.remove('show-details'); el('detailsBody').innerHTML=''; };
  window.addEventListener('keydown', e=>{ if (e.key==='Escape') { document.body.classList.remove('show-details'); el('detailsBody').innerHTML=''; }});

  renderTree();
}

function matches(node, searchText, tagFilter){
  if (tagFilter && !(node.tags||[]).includes(tagFilter)) return false;
  if (!searchText) return true;
  const f = searchText.toLowerCase();
  return (node.label||'').toLowerCase().includes(f) ||
         (node.id||'').toLowerCase().includes(f) ||
         (node.tags||[]).some(t => t.toLowerCase().includes(f));
}

function sortIds(ids){
  const m = app.map;
  const s = ids.slice();
  switch(state.sortMode){
    case 'labelAsc': s.sort((a,b)=>m.get(a).label.localeCompare(m.get(b).label)); break;
    case 'labelDesc': s.sort((a,b)=>m.get(b).label.localeCompare(m.get(a).label)); break;
    case 'idAsc': s.sort(); break;
    case 'idDesc': s.sort().reverse(); break;
    case 'none': default: break;
  }
  return s;
}

function renderNode(id, searchText, tagFilter, filtering){
  const node = app.map.get(id);
  if (!node || state.hidden[id]) return null;

  // Render children first (so we can keep parents that have visible descendants during filter)
  const kids = (app.children.get(id)||[]).map(cid => renderNode(cid, searchText, tagFilter, filtering)).filter(Boolean);

  const ok = matches(node, searchText, tagFilter);
  if (filtering && !ok && kids.length===0) return null;

  const li = document.createElement('li');
  if (!filtering && state.collapsed[id]) li.classList.add('collapsed');

  const row = document.createElement('div'); row.className = 'node';
  const label = document.createElement('div'); label.className = 'label'; label.title = (node.tags||[]).join(', ');
  const swatch = document.createElement('span'); swatch.className = 'swatch'; swatch.style.background = node.color || '#9ca3af';
  const text = document.createElement('span'); text.textContent = node.label || id;
  const idSpan = document.createElement('span'); idSpan.className = 'id'; idSpan.textContent = node.id;

  label.appendChild(swatch); label.appendChild(text); label.appendChild(idSpan);
  label.onclick = (e)=>{ e.stopPropagation(); if (!filtering){ state.collapsed[id] = !state.collapsed[id]; saveState(); renderTree(); } };

  const actions = document.createElement('div'); actions.className='actions';
  const info = document.createElement('button'); info.textContent = 'Info'; info.onclick = (e)=>{ e.stopPropagation(); openDetails(id); };
  const hide = document.createElement('button'); hide.textContent = 'Hide'; hide.onclick = (e)=>{ e.stopPropagation(); state.hidden[id]=true; saveState(); renderTree(); };
  actions.appendChild(info); actions.appendChild(hide);

  row.appendChild(label); row.appendChild(actions);
  li.appendChild(row);

  if (kids.length){
    const ul = document.createElement('ul');
    kids.forEach(el => ul.appendChild(el));
    li.appendChild(ul);
  }
  return li;
}

function renderTree(){
  const tree = el('tree'); tree.innerHTML='';
  const searchText = el('search').value.trim();
  const tagFilter = el('tagFilter').value;
  const filtering = !!searchText || !!tagFilter;
  const ul = document.createElement('ul');

  sortIds(app.roots).forEach(id => {
    const el = renderNode(id, searchText, tagFilter, filtering);
    if (el) ul.appendChild(el);
  });

  // Hidden section
  const hiddenIds = Object.keys(state.hidden).filter(id=>state.hidden[id]);
  if (hiddenIds.length){
    const hiddenWrap = document.createElement('div');
    hiddenWrap.innerHTML = `<strong>Hidden:</strong>`;
    hiddenIds.forEach(hid => {
      const btn = document.createElement('button'); btn.textContent = `Unhide ${app.map.get(hid)?.label || hid}`;
      btn.onclick = ()=>{ delete state.hidden[hid]; saveState(); renderTree(); };
      hiddenWrap.appendChild(document.createElement('br')); hiddenWrap.appendChild(btn);
    });
    tree.appendChild(hiddenWrap);
  }

  tree.appendChild(ul);
}

function openDetails(id){
  const n = app.map.get(id);
  const body = el('detailsBody');
  const inputs = app.edgesByChild.get(id) || [];   // [{from, quantity}]
  const outputs = app.edgesByParent.get(id) || []; // [{to, quantity}]

  const tags = (n.tags||[]).map(t=>`<span class="chip">${t}</span>`).join(' ') || '<span class="empty">No tags</span>';
  const parentsLine = (n.parents||[]).length ? n.parents.join(', ') : '<span class="empty">None</span>';

  const inputsList = inputs.length
    ? `<ul class="list-compact">` + inputs.map(e => `<li>${e.from}${e.quantity!==undefined?` — x${e.quantity}`:''}</li>`).join('') + `</ul>`
    : `<div class="empty">No recorded inputs</div>`;

  const outputsList = outputs.length
    ? `<ul class="list-compact">` + outputs.map(e => `<li>${e.to}${e.quantity!==undefined?` — x${e.quantity}`:''}</li>`).join('') + `</ul>`
    : `<div class="empty">Not used in other items</div>`;

  body.innerHTML = `
    <div class="section">
      <div class="details-title">${n.label}</div>
      <div class="muted">ID: ${n.id}</div>
      <div style="margin-top:.35rem;">${tags}</div>
    </div>
    <div class="section">
      <h3>Direct Parents</h3>
      <div>${parentsLine}</div>
    </div>
    <div class="section">
      <h3>Inputs (with quantities)</h3>
      ${inputsList}
      ${app.edgesByChild.size===0 ? '<div class="empty" style="margin-top:.25rem;">(edges.json not found — quantities unavailable)</div>' : ''}
    </div>
    <div class="section">
      <h3>Used In</h3>
      ${outputsList}
    </div>
    <div class="section">
      <button id="unhideBtn" style="margin-right:.35rem;">Unhide</button>
      <button id="hideBtn">Hide</button>
    </div>
  `;

  const hideBtn = document.getElementById('hideBtn');
  const unhideBtn = document.getElementById('unhideBtn');
  if (state.hidden[id]) unhideBtn.disabled = false; else unhideBtn.disabled = true;
  hideBtn.onclick = ()=>{ state.hidden[id]=true; saveState(); renderTree(); };
  unhideBtn.onclick = ()=>{ delete state.hidden[id]; saveState(); renderTree(); };

  document.body.classList.add('show-details'); document.getElementById('details').scrollTop = 0;
}

init();
</script>
</body>
</html>
